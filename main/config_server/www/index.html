<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Device Configuration</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <main>
    <h1>ESP32 Home Assistant Panel</h1>

    <section>
      <h2>Wi‑Fi Networks</h2>
      <div id="wifi-list"></div>
      <button id="wifi-add">Add Wi‑Fi</button>
    </section>

    <section>
      <h2>Home Assistant Connections</h2>
      <div id="ha-list"></div>
      <button id="ha-add">Add HA Host</button>
    </section>

    <button id="save">Save configuration</button>
    <button id="reboot">Reboot device</button>
    <div id="status"></div>
  </main>

  <script type="text/javascript">
    // Inline ES5-compatible config UI logic

    function loadConfig(callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/api/config", true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState !== 4) {
          return;
        }
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            var data = JSON.parse(xhr.responseText || "{}");
            callback(null, data);
          } catch (e) {
            callback(e);
          }
        } else {
          callback(new Error("HTTP " + xhr.status));
        }
      };
      xhr.send();
    }

    function createWifiRow(item) {
      var div = document.createElement("div");
      div.className = "row wifi-row";

      var ssid = item && item.ssid ? item.ssid : "";
      var password = item && item.password ? item.password : "";

      div.innerHTML =
        '<label>SSID' +
        '<input type="text" name="ssid" value="' + ssid + '">' +
        "</label>" +
        '<label>Password' +
        '<input type="text" name="password" value="' + password + '">' +
        "</label>" +
        '<button type="button" class="danger wifi-remove">Remove</button>';

      var btn = div.querySelector(".wifi-remove");
      btn.addEventListener("click", function () {
        div.parentNode.removeChild(div);
      });

      return div;
    }

    function createHaRow(item) {
      var div = document.createElement("div");
      div.className = "row ha-row";

      var host = item && item.host ? item.host : "";
      var httpPort = item && item.http_port ? item.http_port : 8123;
      var mqttPort = item && item.mqtt_port ? item.mqtt_port : 1883;
      var mqttUser = item && item.mqtt_username ? item.mqtt_username : "";
      var mqttPass = item && item.mqtt_password ? item.mqtt_password : "";
      var httpToken = item && item.http_token ? item.http_token : "";

      div.innerHTML =
        '<label>Host' +
        '<input type="text" name="host" value="' + host + '">' +
        "</label>" +
        '<label>HTTP port' +
        '<input type="number" name="http_port" value="' + httpPort + '">' +
        "</label>" +
        '<label>MQTT port' +
        '<input type="number" name="mqtt_port" value="' + mqttPort + '">' +
        "</label>" +
        '<label>MQTT username' +
        '<input type="text" name="mqtt_username" value="' + mqttUser + '">' +
        "</label>" +
        '<label>MQTT password' +
        '<input type="text" name="mqtt_password" value="' + mqttPass + '">' +
        "</label>" +
        '<label>HTTP token' +
        '<input type="text" name="http_token" value="' + httpToken + '">' +
        "</label>" +
        '<button type="button" class="danger ha-remove">Remove</button>';

      var btn = div.querySelector(".ha-remove");
      btn.addEventListener("click", function () {
        div.parentNode.removeChild(div);
      });

      return div;
    }

    function collectConfig() {
      var wifi = [];
      var wifiRows = document.querySelectorAll(".wifi-row");
      for (var i = 0; i < wifiRows.length; i++) {
        var row = wifiRows[i];
        var ssid = row.querySelector('input[name="ssid"]').value.trim();
        var password = row
          .querySelector('input[name="password"]')
          .value.trim();
        if (ssid) {
          wifi.push({ ssid: ssid, password: password });
        }
      }

      var ha = [];
      var haRows = document.querySelectorAll(".ha-row");
      for (var j = 0; j < haRows.length; j++) {
        var rowHa = haRows[j];
        var host = rowHa.querySelector('input[name="host"]').value.trim();
        var httpPort = parseInt(
          rowHa.querySelector('input[name="http_port"]').value,
          10
        );
        var mqttPort = parseInt(
          rowHa.querySelector('input[name="mqtt_port"]').value,
          10
        );
        var mqttUser = rowHa
          .querySelector('input[name="mqtt_username"]')
          .value.trim();
        var mqttPass = rowHa
          .querySelector('input[name="mqtt_password"]')
          .value.trim();
        var httpToken = rowHa
          .querySelector('input[name="http_token"]')
          .value.trim();

        if (host) {
          ha.push({
            host: host,
            http_port: isNaN(httpPort) ? 8123 : httpPort,
            mqtt_port: isNaN(mqttPort) ? 1883 : mqttPort,
            mqtt_username: mqttUser,
            mqtt_password: mqttPass,
            http_token: httpToken,
          });
        }
      }

      return { wifi: wifi, ha: ha };
    }

    function saveConfig() {
      var status = document.getElementById("status");
      status.textContent = "Saving...";
      var payload = collectConfig();

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/api/config", true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.onreadystatechange = function () {
        if (xhr.readyState !== 4) {
          return;
        }
        if (xhr.status >= 200 && xhr.status < 300) {
          status.textContent = "Saved. You may reboot the device.";
        } else {
          status.textContent = "Save failed";
        }
      };
      xhr.send(JSON.stringify(payload));
    }

    function sendReboot() {
      var status = document.getElementById("status");
      status.textContent = "Rebooting...";

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/api/reboot", true);
      xhr.onreadystatechange = function () {
        // Device will likely reboot immediately after responding.
      };
      xhr.send();
    }

    function main() {
      var wifiList = document.getElementById("wifi-list");
      var haList = document.getElementById("ha-list");

      document
        .getElementById("wifi-add")
        .addEventListener("click", function () {
          wifiList.appendChild(createWifiRow());
        });

      document
        .getElementById("ha-add")
        .addEventListener("click", function () {
          haList.appendChild(createHaRow());
        });

      document
        .getElementById("save")
        .addEventListener("click", function () {
          saveConfig();
        });

      document
        .getElementById("reboot")
        .addEventListener("click", function () {
          sendReboot();
        });

      loadConfig(function (err, cfg) {
        if (err) {
          console.log("Failed to load config:", err);
          var status = document.getElementById("status");
          status.textContent = "Failed to load config";
          return;
        }
        cfg = cfg || {};
        var wifi = cfg.wifi || [];
        var ha = cfg.ha || [];

        for (var i = 0; i < wifi.length; i++) {
          wifiList.appendChild(createWifiRow(wifi[i]));
        }
        for (var j = 0; j < ha.length; j++) {
          haList.appendChild(createHaRow(ha[j]));
        }
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      main();
    });
  </script>
</body>

</html>
